Import-Module MSOnline
Connect-MsolService

$UserList = Get-ADUser -Filter {(extensionattribute5 -like "E3*") -and (office -like "PT*")} -SearchBase 'OU=sites,DC=webhelp,DC=local' -Properties Name, Mail, extensionattribute5, extensionattribute6, title, department, office

$Results = @()
ForEach ($User in $UserList) {
  $UPN = $User.UserPrincipalName
  $LastLogon = (Get-MailboxStatistics $UPN).LastLogonTime
  $Results += New-Object PSObject -Property @{
    'NAME' = $User.Name
    'MAIL' = $User.mail
    'LICENSE Type' = $User.extensionattribute5
    'ATTRIBUTS' = $User.extensionattribute6
    'CATEGORY' = $User.title
    'PROJECT' = $User.department
    'SITE' = $User.office
    'LAST LOGIN' = $LastLogon
  }
}

$Results | Sort-Object NAME, DEPARTMENT | Export-Csv C:\users\rlandeiro\desktop\E3.csv -NoTypeInformation
